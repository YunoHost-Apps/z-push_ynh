#!/bin/bash

source _common.sh
source /usr/share/yunohost/helpers

ynh_app_setting_set --key=php_memory_limit --value=256M

#=================================================
# RETRIEVE ARGUMENTS FROM THE MANIFEST
#=================================================

path="/Microsoft-Server-ActiveSync"
timezone="$(cat /etc/timezone)"

#=================================================
# DOWNLOAD, CHECK AND UNPACK SOURCE
#=================================================
ynh_script_progression "Setting up source files..."

# Download, check integrity, uncompress and patch the source from app.src
mkdir -p "$install_dir/tmp"
ynh_setup_source --dest_dir="$install_dir/tmp"
cp -af "$install_dir/tmp/src/." "$install_dir/."
ynh_safe_rm "$install_dir/tmp"

#REMOVEME? Assuming the install dir is setup using ynh_setup_source, the proper chmod/chowns are now already applied and it shouldn't be necessary to tweak perms | chmod -R o-rwx "$install_dir"
#REMOVEME? Assuming the install dir is setup using ynh_setup_source, the proper chmod/chowns are now already applied and it shouldn't be necessary to tweak perms | chown -R $app:www-data "$install_dir"
#=================================================
# PHP-FPM CONFIGURATION
#=================================================
ynh_script_progression "Installing system configurations..."

# Create a dedicated PHP-FPM config
ynh_config_add_phpfpm

# Create a dedicated NGINX config
ynh_config_add_nginx

mkdir -p "/var/log/$app/"
#REMOVEME? Assuming ynh_config_add_logrotate is called, the proper chmod/chowns are now already applied and it shouldn't be necessary to tweak perms | chmod 750 "/var/log/$app/"
#REMOVEME? Assuming ynh_config_add_logrotate is called, the proper chmod/chowns are now already applied and it shouldn't be necessary to tweak perms | chmod -R o-rwx "/var/log/$app/"
#REMOVEME? Assuming ynh_config_add_logrotate is called, the proper chmod/chowns are now already applied and it shouldn't be necessary to tweak perms | chown -R $app:www-data "/var/log/$app/"

ynh_config_add_logrotate

#=================================================
# ADD A CONFIGURATION
#=================================================
ynh_script_progression "Adding $app's configuration..."

# Enable caldav carddav support
if yunohost app list | grep -q 'id: baikal' ; then
	echo "Detected Baikal"
	baikaldomain=$(ynh_app_setting_get --app="baikal" --key=domain)
	baikalpath=$(ynh_app_setting_get --app="baikal" --key=path)
	baikalpath=${baikalpath%/}

    # Variables to hydrate template
    backend="BackendCombined"
    caldav_server="$baikaldomain"
    caldav_path="${baikalpath}/cal.php/calendars/%u/"
    caldav_personal="default"

    carddav_server="$baikaldomain"
    carddav_path="${baikalpath}/card.php/addressbooks/%u/"
    carddav_default_path="${baikalpath}/card.php/addressbooks/%u/default"

    imap_server="$domain"
    imap_meeting_use_caldav="true"

    ynh_config_add --template="backend/config-caldav.php" --destination="$install_dir/backend/caldav/config.php"
    ynh_config_add --template="backend/config-carddav.php" --destination="$install_dir/backend/carddav/config.php"
    ynh_config_add --template="backend/config-imap.php" --destination="$install_dir/backend/imap/config.php"
    ynh_config_add --template="backend/config-combined.php" --destination="$install_dir/backend/combined/config.php"

elif yunohost app list | grep -q 'id: nextcloud' ; then
	echo "Detected NextCloud"
	nextclouddomain=$(ynh_app_setting_get --app="nextcloud" --key=domain)
	nextcloudpath=$(ynh_app_setting_get --app="nextcloud" --key=path)
	nextcloudpath=${nextcloudpath%/}

    # Variables to hydrate template
    backend="BackendCombined"
    caldav_server="$nextclouddomain"
    caldav_path="${nextcloudpath}/remote.php/dav/calendars/%u/"
    caldav_personal="personal"

    carddav_server="$nextclouddomain"
    carddav_path="${nextcloudpath}/remote.php/dav/addressbooks/users/%u/"
    carddav_default_path="${nextcloudpath}/remote.php/dav/addressbooks/users/%u/"

    imap_server="$domain"
    imap_meeting_use_caldav="true"

    ynh_config_add --template="backend/config-caldav.php" --destination="$install_dir/backend/caldav/config.php"
    ynh_config_add --template="backend/config-carddav.php" --destination="$install_dir/backend/carddav/config.php"
    ynh_config_add --template="backend/config-imap.php" --destination="$install_dir/backend/imap/config.php"
    ynh_config_add --template="backend/config-combined.php" --destination="$install_dir/backend/combined/config.php"

else
    backend="BackendIMAP"
    imap_server="$domain"
    imap_meeting_use_caldav="false"

    ynh_config_add --template="backend/config-imap.php" --destination="$install_dir/backend/imap/config.php"
fi

# Copy config
ynh_config_add --template="config.php" --destination="$install_dir/config.php"
ynh_config_add --template="backend/config-autodiscover.php" --destination="$install_dir/autodiscover/config.php"
ynh_config_add --template="backend/config-searchldap.php" --destination="$install_dir/backend/searchldap/config.php"

#Copy XMLElement.php
ln -s /usr/share/awl/inc/XML* /var/www/$app/include/

#=================================================
# END OF SCRIPT
#=================================================

ynh_script_progression "Installation of $app completed"
